<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indspilning</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- shim -->
    <script src="../modules/shim/Base64.js" type="text/javascript"></script>
    <script src="../modules/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../modules/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="../modules/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="../modules/jasmid/stream.js"></script>
    <script src="../modules/jasmid/midifile.js"></script>
    <script src="../modules/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="../modules/midi_js/audioDetect.js" type="text/javascript"></script>
    <script src="../modules/midi_js/gm.js" type="text/javascript"></script>
    <script src="../modules/midi_js/loader.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.webmidi.js" type="text/javascript"></script>
    <script src="../modules/midi_js/player.js" type="text/javascript"></script>
    <script src="../modules/midi_js/synesthesia.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../modules/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="../modules/util/dom_request_script.js" type="text/javascript"></script>
    <!-- includes -->
    <script src="../modules/inc/colorspace.js" type="text/javascript"></script>
    <script src="../modules/inc/event.js" type="text/javascript"></script>
    <script src="../modules/inc/timer.js" type="text/javascript"></script>
    <!-- tonejs -->
    <script src="https://unpkg.com/@tonejs/midi"></script>
</head>
<body>
    <header>
        <h1>WebMusik - P2</h1>
    </header>
    <div class="topnav">
        <a href="index.html">Home</a>
        <a class="active" href="indspilning.html">Indspilning</a>
        <a href="download.html">Download</a>
        <a href="upload.html">Upload</a>
        <a href="afspilning.html">Afspilning</a>
        <a href="redigering.html">Redigering</a>
        <a href="sammensaetning.html">Sammensætning</a>
        <a href="om.html">Om</a>
        <a href="login.html">Login</a>
        <div class="search-container">
          <form action="server.js">
            <input type="text" placeholder="Search.." name="search">
            <button type="submit">Submit</button>
          </form>
        </div>
    </div>

    <div class="main">
        <input type="button" id="btnStart" value="start">

        <br><br>

        <input type="button" id="btnSendTrack" value="send">

        <br>

        <input type="button" id="btnCreateMidi" value="create">
        <input type="text" size="50" id="trackValue" value="SavedFiles/tracks/song.txt">

        <br>

        <input type="text" name="30" id="trackName" value="trackName">
    </div>

    <script type="text/javascript">
    let currentUser = "mads"

    class midiTrack {
        constructor(name, trackNotes) {
            this.id = -1;
            ( trackNotes !== undefined && trackNotes.length >= 0) ? this.midiNotes = trackNotes : this.midiNotes = [];
            this.name = name;
            this.owner = currentUser;
        };

        addNotes(notes){
            if(notes !== undefined){
                (notes.length > 1 && typeof notes[0] === "object") ? notes.forEach((item, i) => {
                    for (let j = 0; j < item.length; j++) {
                        if (typeof item[j] !== "number") {
                            console.log("note not a number");
                            return -1;
                        }
                    }
                    this.midiNotes.push(item);
                })
                :
                (notes.length === 1 || typeof notes === "object") ? this.midiNotes.push(notes) :
                 console.log("unexpected input: "+notes);
            }
        };

        resetNotes(){
            this.midiNotes = [];
        }

        set newName(newName){
            this.name = newName;
        }

    }
    /* Test
    */
    let testing = true;
    let failedTest = 0;
    let passedTest = 0;

    function test0_midiTrack(){
        let test = new midiTrack("test");

        let expected = "60,60,60";
        let outcome;

        test.addNotes([60,60,60]);

        outcome = test.midiNotes[0].toString();

        if(outcome === expected){
            passedTest += 1;
            return 0;
        }

        failedTest += 1;
        console.log("test0_midiTrack failed\nExpected: "+expected+"\nOutcome: "+outcome);

    }
    function test1_midiTrack(){
        let test = new midiTrack("test");

        let expected = "62,62,62";
        let outcome;

        test.addNotes([[62,62,62], [61,61,61]]);

        outcome = test.midiNotes[0].toString();

        if(outcome === expected){
            passedTest += 1;
            return 0;
        }

        failedTest += 1;
        console.log("test1_midiTrack failed\nExpected: "+expected+"\nOutcome: "+outcome);

    }
    function test2_midiTrack(){
        let test = new midiTrack("test");

        let expected = undefined;
        let outcome;

        outcome = test.addNotes("haha");

        if(outcome === expected){
            passedTest += 1;
            return 0;
        }

        failedTest += 1;
        console.log("test1_midiTrack failed\nExpected: "+expected+"\nOutcome: "+outcome);

    }

    function testAll(){
        test0_midiTrack();
        test1_midiTrack();
        test2_midiTrack();
    }
    if(testing){
        document.body.onload = testAll();
        console.log("Tests done running\nFailed: "+failedTest+"\nPassed: "+passedTest);
    }


    /* Nicholas
    */
    let activeNotes = []; //notes which have yet to be ended
    let noteArray = []; //notes which have been ended

    function newNote(message, noteArray){ // make a new note (duration will be defined in function endNote)
        let note = {
            midi: message.data[1],
            time: message.timeStamp,
            duration: undefined
        }
        activeNotes.push(note);
        console.log(activeNotes[activeNotes.length - 1]);
    }

    function endNote(message, activeNotes, noteArray){
        for (let i = 0; i < activeNotes.length; i++){ // loop through activeNotes
            if (message.data[1] === activeNotes[i].midi){
                activeNotes[i].duration = message.timeStamp - activeNotes[i].time;
                noteArray.push(activeNotes.splice(i, 1)[0]); // removing the ended note from activeNotes, and adding to noteArray
            }
        }
        console.log(noteArray.length);
    }

    async function sendTrack(track){ // !!!NEEDS REVAMPING!!! for sending the track/file (undecided which) to a server
        newTrack = new midiTrack(document.getElementById('trackName').value, track);

        console.log("sending track");
        console.log("track length: " + track.length);
        await fetch('musicData', {
            method: "POST",
            body: JSON.stringify(newTrack),
            headers: {
                "Content-Type": "text/javascript"
            }
        }).then(sendTrackOnFulfilled(newTrack), sendTrackOnRejected);
    }

    function sendTrackOnFulfilled(track){
        console.log("sent track succesfully");
        track.length = 0;
    }

    function sendTrackOnRejected(error){
        alert("COULD NOT SEND TRACK!!11!!1");
    }

    function main(){
        /*  Her indlæses MIDI.js plugin.
         *  Det hele er sat i en funktion for at sørge for at AudioContext ikke
         *  bliver forhindret i at starte, hvis browseren forlanger at en bruger
         *  skal starte handlingen.
         */
        MIDI.loadPlugin({
            soundfontUrl: "./FluidR3_GM/",
            instrument: 0,
            onsuccess: function() { }
        });

        /* Web MIDI Api til at lede efter MIDI controllere.
        */
        navigator.requestMIDIAccess()
        .then(onMIDISuccess, onMIDIFailure);

        function onMIDIFailure() {
            console.log('Could not access your MIDI devices.');
        }

        /* Hvis der er nogle, sæt en funktion til at aktivere, når der kommer
        *  en MIDI besked fra controlleren.
        */
        function onMIDISuccess(midiAccess) {
            for (let input of midiAccess.inputs.values()){
                input.onmidimessage = getMIDIMessage;
            }

            console.log(midiAccess);

            var inputs = midiAccess.inputs;   // Input controllere
            var outputs = midiAccess.outputs; // Output controllere
        }

        /* Denne funktion agere på beskeder fra controlleren, og bruger MIDI.js
        *  til at afspille lyd.
        */
        function getMIDIMessage(midiMessage) {
            //console.log(midiMessage);
            switch (midiMessage.data[0]) {
                case 144: // note On channel 1
                    console.log("noteOn() "+midiMessage.data[1]);
                    newNote(midiMessage, activeNotes);
                    MIDI.noteOn(0, midiMessage.data[1], midiMessage.data[2]);

                    break;
                case 128: // note Off channel 1
                    console.log("noteOff() "+midiMessage.data[1]);
                    MIDI.noteOff(0, midiMessage.data[1], midiMessage.data[2]);
                    endNote(midiMessage, activeNotes, noteArray);

                    break;
                case 192: // switch program channel 1
                    console.log("switching instrument to "+ MIDI.GM.byId[midiMessage.data[1]].instrument);
                    MIDI.programChange(0, midiMessage.data[1]);
                    MIDI.loadPlugin({
                        instrument: midiMessage.data[1]
                    });
                default:
            }
        }
    }

    /* Funktion til at sende POST request til serveren.
    *  Denne vil sende track information til serveren,
    *  og derefter vil serveren lave midi filen.
    */
    function createMidi(track){
        console.log("createMidi() track: ");
        console.log(track);
        let data = JSON.stringify(track.toArray());
        fetch ("newMidiFile", {
            headers:{
                "content-type":"application/json; charset=UTF-8"
            },
            body: data,
            method:"POST"
        })
        .then(data=>{return data})
        .then(res=>{console.log(res)})
        .catch(error=>console.log(error));
    }

    /* Får data fra en track og returnerer det
    *  som et promise
    */
    async function getMidiTrack(trackName){
        try {
            const response = await fetch (trackName, {
                headers:{
                    "content-type":"application/json; charset=UTF-8"
                },
                method: "GET"
            });
            const data = await response.text();

            //console.log(data);

            return data;
        } catch (e) {
            console.log(e);
        }
    }
    async function getMidiTrackById(owner, id){
        try {
            const response = await fetch ("SavedFiles/tracks/"+owner+".txt", {
                headers:{
                    "content-type":"application/json; charset=UTF-8"
                },
                method: "GET"
            });
            const data = await response.text();

            let dataSet = data.split("\n");

            for (let i = 0; i < (dataSet.length-2); i++) { //To tomme data set pga \n derfor -2
                //console.log(i +"# data set: "+dataSet[i]);
                let tempParse = JSON.parse(dataSet[i])
                if( tempParse.id === id ){
                    return dataSet[i];
                }
            }

            return -1;
        } catch (e) {
            console.log(e);
        }
    }

    /* Lave en midi fra et track teskt dokument.
    *  Bruger getMidiTrack og createMidi.
    */
    async function createMidiFromTrack(track){
        const tempMidi = new Midi();
        const tempTrack = tempMidi.addTrack();

        const data = await getMidiTrack(track);

        let trackData = JSON.parse(data);

        for (let i = 0; i < trackData.length; i++) {
            tempTrack.addNote({
                midi: trackData[i].midi,
                ticks: trackData[i].time,
                durationTicks: trackData[i].duration
            });
        }

        createMidi(tempMidi);
    }

    /* Knapper
    */
    function btnSendTrack(){
        sendTrack(noteArray);
    }

    function btnCreateMidi(){
        createMidiFromTrack(document.getElementById('trackValue').value);
    }

    document.getElementById('btnStart').addEventListener("click", main);
    document.getElementById('btnSendTrack').addEventListener("click", btnSendTrack);
    document.getElementById('btnCreateMidi').addEventListener("click", btnCreateMidi);

    </script>
</body>
</html>
