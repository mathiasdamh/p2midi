<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- shim -->
    <script src="../modules/shim/Base64.js" type="text/javascript"></script>
    <script src="../modules/shim/Base64binary.js" type="text/javascript"></script>
    <script src="../modules/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="../modules/shim/WebMIDIAPI.js" type="text/javascript"></script>
    <!-- jasmid package -->
    <script src="../modules/jasmid/stream.js"></script>
    <script src="../modules/jasmid/midifile.js"></script>
    <script src="../modules/jasmid/replayer.js"></script>
    <!-- midi.js package -->
    <script src="../modules/midi_js/audioDetect.js" type="text/javascript"></script>
    <script src="../modules/midi_js/gm.js" type="text/javascript"></script>
    <script src="../modules/midi_js/loader.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.audiotag.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.webaudio.js" type="text/javascript"></script>
    <script src="../modules/midi_js/plugin.webmidi.js" type="text/javascript"></script>
    <script src="../modules/midi_js/player.js" type="text/javascript"></script>
    <script src="../modules/midi_js/synesthesia.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="../modules/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="../modules/util/dom_request_script.js" type="text/javascript"></script>
    <!-- includes -->
    <script src="../modules/inc/colorspace.js" type="text/javascript"></script>
    <script src="../modules/inc/event.js" type="text/javascript"></script>
    <script src="../modules/inc/timer.js" type="text/javascript"></script>
    <!-- tonejs -->
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <!-- c117 -->
    
</head>
<body>
    <header>
        <h1>WebMusic - P2</h1>
    </header>
    <div class="topnav">
        <a href="index.html">Home</a>
        <a href="indspilning.html">Recording</a>
        <a href="download.html">Download</a>
        <a href="upload.html">Upload</a>
        <a class="active" href="afspilning.html">Playing</a>
        <a href="redigering.html">Edit</a>
        <a href="sammensaetning.html">Composition</a>
        <a href="om.html">About</a>
        <a href="login.html">Login</a>
        <div class="search-container">
          <form action="server.js">
            <input type="text" placeholder="Search.." name="search">
            <button type="submit">Submit</button>
          </form>
        </div>
    </div>
    <h2>Here you can play, not only your own, MIDI files, but also other artist's MIDI files</h2>
    <div class="main">
        <div class="wrapper">
            <input type="button" class="button" id="btn_play" value="Play/Stop">
            <input type="button" class="button" id="btn_pause" value="Pause/Resume">

            <br>

            <input type="button" class="button" id="btn_load" value="Load">
            <input type="text" id="midi_file" value="SavedFiles/midi/track_channelTest.mid">

            <br>

            <p>Change BPM (need to reload file)</p>
            <input type="number" id="inputBPM" value="120">
            <input type="button" class="button" id="btnChangeBPM" value="Change">

            <p id="BPM">BPM: 0</p>
            <p id="PPQ">PPQ: 0</p>
            <p id="timer">0 / 0</p>
        </div>

        <script type="text/javascript">
            let playerBPM = 0; // beats per minute, styrer afsplinnings hastighed
            let midiPPQ = 0; // pulses per quarter note, hvor mange midi beskeder per 1/4 node.
            let playerTime = 0; // tiden der tæller op
            let playerEnd = 0; // slut tiden

            let midi; // holder midi data som JSON
            let timer; // holder intervallet der tæller op.
            let timerRunning = false; // sørger for der kun er et kørende interval
            let fileLoaded = false;

            // Indlæser
            MIDI.loadPlugin({
                soundfontUrl: "FluidR3_GM/",
                onsuccess: function() {console.log("ready");},
            });

            /* Starting the timer for the song.
             * Makes sure to not start another if one is already running
             */
            function startTimer(){
                if(!timerRunning){
                    if(playerEnd.toFixed(1) == playerTime.toFixed(1)) playerTime = 0;
                    console.log("started timer");

                    // Starter et interval der tæller op
                    timer = setInterval(function(){
                        if(MIDI.Player.playing) {
                            playerTime += 0.01;
                            updateTime(playerTime, playerEnd);
                        }

                    } , 10);
                    // Sørger for at intervallet ikke dobbelt startes
                    timerRunning = !timerRunning;
                }
            };

            // Stopper timeren helt og resetter playerTime
            function stopTimer(){
                console.log("stopped timer");
                clearInterval(timer);

                playerTime = 0;
                updateTime(playerTime, playerEnd);

                if(timerRunning) timerRunning = !timerRunning;
            };

            // Pauser timeren
            function pauseTimer(){
                console.log("paused timer");
                clearInterval(timer);

                // Player time bliver sat til currentTime, så den ikke tæller for meget
                playerTime = (MIDI.Player.currentTime/1000);

                if(timerRunning) timerRunning = !timerRunning;
            };

            // basic funktion til at updatere noget HTML
            function updateTime(current, end){
                document.getElementById('timer').innerHTML =
                current.toFixed(2) + " / " + end.toFixed(2)
            }

            // basic funktion til at updatere noget HTML
            function updateBpmPpq(){
                document.getElementById('PPQ').innerHTML = "PPQ: "+midiPPQ;
                document.getElementById('BPM').innerHTML = "BPM: "+playerBPM;
            }

            // Indlæser alle instrumenter fra alle tracks
            function loadInstruments(midiData){
                console.log("loading instruments");
                try {
                    for (let i = 0; i < midi.tracks.length; i++) {
                        console.log("channel: "+midi.tracks[i].channel+", program: "+midi.tracks[i].instrument.number);
                        // Indlæser selve instrumentet så det kan bruges af midi afspilleren
                        MIDI.loadResource({
                            instrument: midi.tracks[i].instrument.number,
                            onsuccess: function(){
                                console.log("loaded instrument: "+midi.tracks[i].instrument.number);
                            }
                        });

                        // Sørger for at channels har et rigtigt start instrument
                        MIDI.programChange(midi.tracks[i].channel, midi.tracks[i].instrument.number);
                    }
                } catch (e) {
                    console.log(e);
                    console.log("error in loadInstruments(midiData)");
                } finally {
                    console.log("instruments loaded");
                }
            }

            /* Læser en fil fra file_path parameteren,
             * så den er klar til at afspille sangen.
             */
            async function load_file(file_path){
                console.log(file_path);
                console.log("start load_file()" + file_path);
                fileLoaded = false;

                midi = await getMidiData(file_path);

                console.log(midi);

                midiPPQ = midi.header.ppq;
                playerTime = 0;
                playerBPM = MIDI.Player.BPM;

                loadInstruments(midi);

                MIDI.Player.loadFile(file_path, () => {
                    console.log("file loaded "+file_path);
                    playerEnd = (MIDI.Player.endTime/1000);

                    updateBpmPpq()
                    updateTime(playerTime, playerEnd);

                    MIDI.Player.addListener(function(data) {
                        console.log(data.now +"/"+data.end+" "+data.channel);

                        if(data.now === data.end) {
                            MIDI.Player.stop();
                            stopTimer();
                            console.log("end of song, stopping player");
                        };
                    });
                    fileLoaded = true;
                })
            };

            // Skaffer midi data vha. tonejs/midi og putter det i JSON
            async function getMidiData(filePath){
                const midiData = await Midi.fromUrl(filePath);
                return midiData;
            };

            /* ####################################################
             * ####################################################
             * ################     KNAPPER     ###################
             */

            /* Knap der afspiller sangen, hvis MIDI.player ikke spiller, og stopper
            *  den hvis den spiller.
            */
            function btn_play(){
                playerBPM = MIDI.Player.BPM

                console.log(MIDI.Player.playing + " start btn_play()");
                if (MIDI.Player.playing) {
                    MIDI.Player.stop();
                    stopTimer();
                } else {
                    MIDI.Player.stop();
                    MIDI.Player.start();
                    startTimer();
                };
            };

            /* Ligesom btn_play, men i stedet afspiller den fra der man pausede.
            */
            function btn_pause(){
                console.log(MIDI.Player.playing + " start btn_pause()");
                if (MIDI.Player.playing) {
                    MIDI.Player.pause();
                    pauseTimer();
                } else {
                    MIDI.Player.resume();
                    startTimer();
                };
            }

            /* Knap til at loade en fil.
            */
            function btn_load(){
                let file_name = document.getElementById('midi_file').value;
                load_file(file_name);
            }

            /* Knap til at skifte BPM
             */
            function btnChangeBPM(){
                console.log("changed BPM");
                MIDI.Player.BPM = document.getElementById('inputBPM').value;
                updateBpmPpq();
            }

            /* Knap event listeners
            */
            document.getElementById('btn_play').addEventListener("click", btn_play);
            document.getElementById('btn_load').addEventListener("click", btn_load);
            document.getElementById('btn_pause').addEventListener("click", btn_pause);
            document.getElementById('btnChangeBPM').addEventListener("click", btnChangeBPM);

            // ######################################################
            // ######################################################
            function makeTestMidi(){
                const tempMidi = new Midi();
                let trackArray = [];

                for (let i = 0; i < 16; i++) {
                    trackArray.push(tempMidi.addTrack());
                    trackArray[i].channel = i;
                    trackArray[i].instrument.number = 0;
                    trackArray[i].addNote({
                        midi: (60+i),
                        duration: 1,
                        time: (1+i)
                    })
                }

                createMidi(tempMidi, "channelTest");
            }

            async function createMidi(midiData, name){
                console.log("creating midi file with name: "+name);
                console.log("midi data being sent:");
                console.log(midiData);
                let data = JSON.stringify(midiData.toArray()); // Sender dataet i en string til serveren
                try {
                    const response = await fetch ("newMidiFile", {
                        headers:{
                            "content-type":"application/json; charset=UTF-8",
                            "song-name":name,
                            "owner-name":"mads"
                        },
                        body: data,
                        method:"POST"
                    })

                } catch (e) {
                    console.log(e);

                }
            }
        </script>
    </div>

</body>
</html>
